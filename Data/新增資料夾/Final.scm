(define Macro1
   (lambda ( )
    (insert:part "D:/GAPY/file/prism_sat_file.SAT")
(view:profiles "xy")
(view:zoom-all)
(edit:select-all-objects)
(edit:remove-selection (entity 31))
(edit:remove-selection (entity 52))
(edit:remove-selection (entity 53))
(property:apply-material (entity 1) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 2) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 3) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 4) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 5) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 6) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 7) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 8) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 9) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 10) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 11) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 12) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 13) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 14) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 15) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 16) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 17) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 18) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 19) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 20) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 21) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 22) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 23) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 24) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 25) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 26) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 27) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 28) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 29) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 30) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 51) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 32) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 33) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 34) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 35) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 36) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 37) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 38) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 39) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 40) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 41) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 42) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 43) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 44) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 45) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 46) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 47) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 48) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 49) "SCHOTT" "BK7" (gvector 0 0 0))
(property:apply-material (entity 50) "SCHOTT" "BK7" (gvector 0 0 0))
(edit:clear-selection)
(edit:add-selection (entity 31))
(edit:add-selection (tools:face-in-body 0 (entity 31)))
(edit:clear-selection)
(edit:add-selection (entity 52))
(property:apply-material (entity 52) "SCHOTT" "SSKN5" (gvector 0 0 0))
(edit:clear-selection)
(edit:add-selection (entity 53))
(property:apply-material (entity 53) "SCHOTT" "BK7" (gvector 0 0 0))
(edit:clear-selection)
(edit:add-selection (tools:face-in-body 1 (entity 53)))
(edit:add-selection (tools:face-in-body 3 (entity 53)))
(property:apply-surface (tools:face-in-body 1 (entity 53)) (list "Perfect Absorber" "Default")
  (gvector 0 0 0) (gvector 0 0 0)
  (position 0 0 0) (gvector 0 0 0) #t)
(property:apply-surface (tools:face-in-body 3 (entity 53)) (list "Perfect Absorber" "Default")
  (gvector 0 0 0) (gvector 0 0 0)
  (position 0 0 0) (gvector 0 0 0) #t)
(property:apply-flux-surface-source (tools:face-in-body 0 (entity 31)) 100 1000 2 #f)
(analysis:candela-normal (gvector 0 -1 0))
(analysis:candela-up (gvector -1 0 0))
(analysis:candela-ray-type "missed")
(analysis:candela-symmetry "none")
(analysis:candela-distribution 1 #f 540 #t #f)
(analysis:candela-distribution-luminaire 180)
(analysis:candela-distribution-max #f 0)
(analysis:candela-distribution-min #f 0)
(analysis:candela-distribution-log-plot #t)
(analysis:candela-rect-distribution-angular-width 180)
(raytrace:source)     
     
     
     (define ang_ini 10)             ;;初始仰角
     (define end 85)                ;;最終仰角
     (define angle 10)               ;;間隔角度
     (define rays_ini 1000)         ;;初始光線數
     (define rays_end 1000)
     (define rays_times 2)          ;;光線數倍數
     (define ini (- ang_ini angle))
     (define rays (/ rays_ini rays_times))
     (define name "prism light trace data")                           
     (define no1 "1_")  
     (define no2 "2_")
     (define no3 "3_")
     (define no4 "4_")
     (define bmp ".bmp")         
     (define txt ".txt")                      
     (define s1 "-")                     
     (define PCD "PCD")   
     (define RCD "RCD")
     (do                                     ;; loop over "i" form      
       ((i (+ ini angle) (+ i angle)))       ;; 初始仰角 (0) to 最終仰角 by + num 度      
       ((> i end))                           ;; quit when i is 最終仰角             
       (define s2 (number->string i))     
       (entity:rotate (entity 31) 55 490 0 0 0 1 angle);;對z軸旋轉 num 度  
       (do                     
         ((i (* rays rays_times) (* i rays_times)))                       
         ((> i rays_end))    
         (define s8 (number->string i))                                       
         (define bmp (string-append name s1 no1 s2 bmp ))
         (define pcd (string-append name s1 no2 s2 PCD bmp ))
         (define rcd (string-append name s1 no3 s2 RCD bmp ))
         (define txt (string-append name s1 no4 s2 txt))
         (raytrace:source)                          
         (file:save-as bmp)    
         (analysis:candela-save-bmp "polar-distribution" pcd)    
         (analysis:candela-save-bmp "rectangular-distribution" rcd)                           
         (analysis:candela-save-txt "polar-distribution" txt 361)
         )      
       ;;(entity:rotate (entity 31) 55 390 0 0 0 1 angle)                   
       )
      (file:save-as "D:/GAPY/file/Untitled.OML")
      (file:close)
      (file:new)
     
))
(Macro1)